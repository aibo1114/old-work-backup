// Generated by CoffeeScript 1.12.7
(function() {
  app.enhance({
    routes: {
      '!/group/:id/thread/:tid': 'thread'
    },
    thread: function(gid, id) {
      return app.dm.model(ctn, 'thread', id, {
        auto: false,
        mode: null,
        slideUrl: app.prev() ? true : false,
        tmpl: 'groupTaskView',
        context: function() {
          var cd, d, mg, task, uInfo;
          d = this.model.toJSON();
          mg = app.myGroup.toJSON();
          cd = new Date(d.dateCreated);
          uInfo = {};
          app.groupMember.each(function(it) {
            if (it.get('user')._id === d.user._id) {
              uInfo = it.toJSON();
              return cf.muid = uInfo._id;
            }
          });
          if (d.form) {
            task = mg.task.findBy('subData.code', d.form.code);
          }
          return $.extend(d, {
            group: mg,
            task: task,
            intro: _.compact([uInfo.industry, uInfo.jobTitle, uInfo.company]),
            statement: uInfo.statement,
            hasEdit: user.isOwner(d.user._id),
            hasBack: app.inSlides(),
            hasAdv: false,
            hasComment: true,
            title: d.title ? util.adjustText(d.title, 20) : d.user.username + "的读书分享",
            subTitle: cd.pattern('MM月dd日') + (" 第" + ((-new Date(mg.startedDate).minusTime(cd)) + 1) + "天")
          });
        },
        events: {
          'click .editIt': function() {
            var code, o, opt;
            o = {
              toFetch: false,
              model: this.model,
              _saveSuccess: function(model) {
                model.trigger('change');
                return cf.slider.slidePage();
              }
            };
            opt = this.model.get('cat') === 'post' ? o : (code = this.model.get('form').code, $.extend({}, app.myGroup.get('task').findBy('subData.code', code).subData, o));
            return app.dm.edit('slide', 'thread', null, opt);
          }
        },
        afterAjax: function() {
          var oL, ob;
          ob = this.model.toJSON();
          cf.userFunc(this.$('.dBtns'), ob);
          cf.addComment(this.$('.reply'), ob);
          oL = "mobReadThread?tid=" + id + "&gmid=" + cf.muid;
          if (util.isWechat()) {
            _.delay((function(_this) {
              return function() {
                var url;
                url = wt.genWtUrl(oL, null, null, 'snsapi_base');
                return wt.setShare(_this.$('h2 strong').text(), url, _this.$('img').attr('src'), tu.adt(_this.model.get('content'), 50), "thread/_id/" + id + "/share");
              };
            })(this), 1500);
          }
          if (user.username === 'alex') {
            return this.$('.dBtns').mk('p', {
              "class": 'text-xs-center m-t-1'
            }, tu.a('外链', '/' + oL));
          }
        }
      });
    }
  });

}).call(this);

//# sourceMappingURL=thread.js.map
