// Generated by CoffeeScript 1.12.7
(function() {
  var area, phone;

  area = require('../../../lib/widget/editor/areaCode');

  require('../../../lib/widget/editor/dTime');

  phone = {
    code: 'phone',
    type: 'text',
    icon: 'phone',
    label: '手机号',
    ph: '手机号码',
    help: '用于信息查询与找回密码',
    isShow: function() {
      return !user.isLogin();
    },
    valid: {
      required: true,
      telephone: true
    }
  };

  app.enhance({
    routes: {
      '!/apply/inquiry': 'inquiry',
      '!/apply/order': 'order'
    },
    initLayout: function() {
      return this.ctn.appned("<div class='col-md-push-2 col-md-8 row'/>");
    },
    inquiry: function(id) {
      var em, et, ph, ref;
      if (!$(W.ctn).length) {
        W.ctn = app.ctn;
      }
      if (window.wt) {
        wt.setWtJs();
      }
      ph = location.pathname;
      ref = ph.split('/'), em = ref[0], et = ref[1], id = ref[2];
      return this.dm.form(W.ctn, 'inquiry', {
        tip: '您输入的电话号码，将会最为咨询结果的查询密码',
        title: '我的咨询',
        _vcodeExist: function() {
          popMsg('您的电话已经注册,请登录后再咨询');
          cf._toLogin = location.hash;
          return cf.r('login');
        },
        prop: [_ep('username'), phone, _ep('vcode'), _ep('content:content'), m._pic('head')],
        toFetch: false,
        data: function() {
          var cu, d, sh;
          if (et === 'shop') {
            d = {
              shop: _shop
            };
          } else if (et === 'consultant') {
            d = {
              consultant: {
                _id: id,
                username: $('#username').text()
              }
            };
            if ((cu = $('#cuid')) && cu.length) {
              d.consultant.uid = cu.val();
            }
            if ((sh = $('#shop')) && sh.length) {
              d.shop = {
                _id: sh.attr('sid'),
                title: sh.text(),
                address: $('#shop_addr').text(),
                phone: $('#shop_phone').text()
              };
            }
          } else {
            d = {};
          }
          if (user.isLogin()) {
            d.username = user.username;
            d.phone = user.get('phone');
            d.uid = user.id;
          }
          return d;
        },
        _saveSuccess: function() {
          if (user.isLogin()) {
            popMsg('您的问题已经成功提交！');
            return cf.r("my/qa");
          } else {
            popMsg('您的问题已经成功提交！2个工作日内您将收到答复，您可以通过注册网站,然后查看您的回答.');
            return cf.r('reg');
          }
        }
      });
    },
    order: function() {
      var cu, d, em, et, id, ph, ref, sh;
      if (!$(W.ctn).length) {
        W.ctn = app.ctn;
      }
      ph = location.pathname;
      ref = ph.split('/'), em = ref[0], et = ref[1], id = ref[2];
      if (et === 'shop') {
        d = {
          status: 10,
          shop: _shop
        };
      } else if (et === 'consultant') {
        d = {
          status: 10,
          consultant: {
            _id: id,
            username: $('#username').text()
          }
        };
        if ((cu = $('#cuid')) && cu.length) {
          d.consultant.uid = cu.val();
        }
        if ((sh = $('#shop')) && sh.length) {
          d.shop = {
            _id: sh.attr('sid'),
            title: sh.text(),
            address: $('#shop_addr').text(),
            phone: $('#shop_phone').text()
          };
        }
      } else {
        d = {};
      }
      if (user.isLogin()) {
        d.username = user.username;
        d.phone = user.get('phone');
        d.uid = user.id;
      }
      return this.dm.form(W.ctn, 'order', {
        tip: '请输入常用电话号码，方便我们与您的沟通',
        title: '我的预约',
        toFetch: false,
        _vcodeExist: function() {
          popMsg('您的电话已经注册,请登录后再预约');
          cf._toLogin = location.hash;
          return cf.r('login');
        },
        prop: [
          _ep('username'), _ep('user:gender'), m._number('age', {
            label: '年龄'
          }), phone, _ep('vcode'), m._tag('hr'), {
            code: 'postcode',
            type: 'holder',
            label: '选择地区',
            xtype: area,
            events: {
              'click .searchShop': function(e) {
                var code, sb;
                code = this.model.get('postcode');
                sb = $('#_shopId').data('sb');
                if (code) {
                  sb.form.model.unset('shop');
                  $('#_shopId').find('input').val('');
                  sb.form.model.unset('consultant');
                  $('#_consultantId').find('input').val('');
                  sb.reset();
                  sb.lazy = false;
                  return sb.showBox({
                    postcode: code
                  });
                } else {
                  sb.lazy = true;
                  return popMsg('请先选择地区，再搜索', 'warning');
                }
              }
            },
            attrs: {
              prop: 'postcode',
              auto: '80',
              callback: function() {
                var a, btn;
                btn = _st.btn('primary');
                a = "<a class='" + btn + " searchShop'>查询验配中心</a>";
                return $('.areaWt').append(a);
              }
            }
          }, {
            code: 'shop',
            id: '_shopId',
            type: 'text',
            xtype: 'selectBox',
            ph: '请按照地址和名称进行检索',
            bind: true,
            readonly: true,
            showText: function(v, d) {
              if (d) {
                return "<a target='_blank' href='/shop/" + d._id + "'>" + d.title + "</a>";
              }
            },
            attrs: {
              setAttrs: 'title,address,phone',
              panelOpt: {
                entity: 'shop',
                noStr: '没有匹配对象',
                criteriaOpt: {
                  _attrs: 'title,consultant,address,refFile,phone'
                }
              },
              queryOpt: function(v) {
                return {
                  $or: [
                    {
                      title: {
                        $regex: ".*" + v + ".*"
                      },
                      address: {
                        $regex: ".*" + v + ".*"
                      }
                    }
                  ]
                };
              },
              label: 'title',
              lazy: false,
              afterPick: function(data) {
                this.form.model.unset('consultant');
                $('#_consultantId').find('input').val('');
                if (data.consultant) {
                  $('#_consultantId').data('sb').reset(data.consultant);
                  return $('#_consultantId').find('input').attr('readonly', 'readonly');
                }
              }
            }
          }, {
            code: 'consultant',
            id: '_consultantId',
            type: 'text',
            xtype: 'selectBox',
            bind: true,
            ph: '请按照名字查找',
            readonly: true,
            showText: function(v, d) {
              if (d) {
                return "<a target='_blank' href='/consultant/" + d._id + "'>" + d.username + "</a>";
              }
            },
            attrs: {
              setAttrs: 'username',
              searchItem: 'username',
              label: 'username',
              reset: function(data) {
                this.clickShow = true;
                this.lazy = true;
                if (data) {
                  this.panelOpt.data = data;
                  this.setPanel();
                  return this.showBox();
                }
              },
              queryOpt: function(v) {
                return {
                  username: {
                    $regex: ".*" + v + ".*"
                  }
                };
              },
              panelOpt: {
                entity: 'consultant',
                noStr: '没有匹配对象',
                criteriaOpt: {
                  _attrs: 'username,shop'
                }
              },
              afterPick: function(d) {
                if (!this.form.model.get('shop')) {
                  $('#_shopId').find('input').val(d.shop.title);
                  return this.form.model.set('shop', d.shop);
                }
              }
            }
          }, {
            code: 'appointmentTime',
            type: 'text',
            label: '预约时间',
            xtype: 'dTime',
            showText: function(v) {
              return util.prettyDate(v);
            }
          }, m._checkbox('symptom', {
            label: '症状选择',
            attrs: {
              inline: true,
              data: ['听力下降', '听不清', '打岔', '耳鸣', '耳闷', '耳痛', '流水', '流脓', '耳痒', '眩晕', '其他']
            }
          }), m._tag('hr'), m._textarea('memo')
        ],
        rMsg: '您的预约已经提交，2个工作日内工作人员将于您联系，或者请致电：400-0688-153',
        data: function() {
          return d;
        },
        beforeRender: function() {
          d = this.data;
          if (d.shop || d.consultant) {
            this.prop.delBy('postcode', 'code');
            this.prop.delBy('shop', 'code');
            this.prop.delBy('consultant', 'code');
          }
          this._msg = '';
          if (d.shop) {
            this._msg += "验配中心: " + d.shop.title + " [" + (d.shop.address || '') + "]<br/>";
            if (d.consultant) {
              return this._msg += "预约验配师: " + d.consultant.username;
            } else {
              return this._msg += '预约验配师: 店里为您安排验配师';
            }
          } else if (d.consultant) {
            return this._msg += "预约验配师: " + d.consultant.username;
          }
        },
        callback: function() {
          if (this._msg) {
            return this.msg(this._msg, 'info');
          }
        },
        _saveSuccess: function() {
          if (user.isLogin()) {
            popMsg('您的预约已经成功提交！');
            return cf.r("my/order");
          } else {
            popMsg('您的预约已经成功提交！2个工作日内您将收到答复，您可以通过注册网站,然后查看您的回答.');
            return cf.r('reg');
          }
        }
      });
    }
  });

}).call(this);

//# sourceMappingURL=apply.js.map
